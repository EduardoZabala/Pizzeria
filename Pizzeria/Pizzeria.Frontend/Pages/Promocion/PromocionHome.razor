@inject IRepository Repository
@inject NavigationManager NavigationManager
@inject SweetAlertService SweetAlertService
@page "/Promociones"

<GenericList MyList="Promociones">
    <Body>
        <div class="promociones-container">
            <h2 class="promociones-titulo">Promociones Disponibles</h2>
            <div class="centrar">
                <div class="promociones-grid">
                    @foreach (var promocion in Promociones)
                    {
                        <div class="promocion-card">
                            <img src=@($"data:image/jpg;base64,{Getphoto(promocion.Foto)}") class="promocion-imagen" />
                            <h3>
                                @promocion.nombre
                            </h3>
                            <p>
                                @promocion.Descripcion
                            </p>
                            <button class="boton-agregar" @onclick="() => AgregarDescuento(promocion.Id)">Agregar al carrito</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </Body>
</GenericList>

@code {
    public List<Promocion> Promociones { get; set; }
    public List<Archivo> Archivos { get; set; }
    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }
    private async Task LoadAsync()
    {
        await base.OnInitializedAsync();
        var responseHttp = await Repository.GetAsync<List<Promocion>>("api/Promocion");
        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            await SweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            return;
        }
        Promociones = responseHttp.Response!;
        var responseHttp2 = await Repository.GetAsync<List<Archivo>>("api/Archivos");
        if (responseHttp2.Error)
        {
            var message = await responseHttp2.GetErrorMessageAsync();
            await SweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            return;
        }
        Archivos = responseHttp2.Response!;
    }
    private string Getphoto(string imageName)
    {
        Archivo fotoPromocion = Archivos.Find(A => A.FileName == imageName);
        if (fotoPromocion == null)
        {
            return "";
        }
        return Convert.ToBase64String(fotoPromocion.Content);
    }
    private void AgregarDescuento(int promocionId)
    {
        NavigationManager.NavigateTo("/orders/create/discount/" + promocionId);
    }

}